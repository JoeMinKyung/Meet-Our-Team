<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방명록</title>
    <!-- style.css -->
    <link rel="stylesheet" href="css/style.css" />
    <style>
        .myGuestBook {
            /*박스 안의 내용물 가운데 정렬*/
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .myCard {
            background-color: #f9f9f9;
            padding: 20px;
        }
        .myCard>p {
            font-size: 14px;
            line-height: 1.5;
        }
        #guestBook {
            width: 80%;
        }
    </style>
    <!-- bootstrap card -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
        // Firebase SDK 라이브러리 가져오기
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";

        import {
            getFirestore,
            doc,
            deleteDoc,
            updateDoc,
            collection,
            addDoc,
            getDocs,
            getDoc
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebase 구성 정보 설정
        const firebaseConfig = {
            apiKey: "AIzaSyBkQICiWSjg5HOoTbRABf_3vKGWiRuXjXk",
            authDomain: "sparta-99127.firebaseapp.com",
            projectId: "sparta-99127",
            storageBucket: "sparta-99127.firebasestorage.app",
            messagingSenderId: "21636541090",
            appId: "1:21636541090:web:53ae33565c0f1bed2745fb",
            measurementId: "G-J0J83TFTXV"
        };

        // Firebase 인스턴스 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        $("#btn_posting").click(async function () {
            let username = $('#username').val();
            let password = $('#password').val();
            let message = $('#message').val();

            let doc = {
                'username': username,
                'password': password,
                'message': message
            };
            await addDoc(collection(db, "postings"), doc);

            window.location.reload();
        })
        let boolean = true;
        $('#btn_toggle').click(function () {

            $('#postingbox').toggle();
            if (boolean == true) {
                $('#btn_toggle').text('펼치기');
                boolean = false;
            } else {
                $('#btn_toggle').text('접기');
                boolean = true;
            }
        })

        // postings 컬렉션 읽어오기
        let guestBooks = await getDocs(collection(db, "postings"));
        guestBooks.forEach((book) => {
            let row = book.data();

            let username = row['username'];
            let message = row['message'];
            let id = book.id;

            let temp_html = `
            <div class="myCard card-body shadow-sm rounded p-4">
                <h5 class="card-title text-primary fw-bold">${username}</h5>
                <p class="card-text text-muted">${message}</p>
                <input class="cardId" type="hidden" value="${id}">
                <div class="d-flex justify-content-end">
                    <a href="#" class="btn btn-outline-primary btn-sm me-2 cardBtn cardUpdateBtn" data-bs-toggle="modal" data-bs-target="#passwordModal" data-bs-whatever="@mdo">수정하기</a>
                    <a href="#" class="btn btn-outline-danger btn-sm cardBtn cardDeleteBtn" data-bs-toggle="modal" data-bs-target="#passwordModal" data-bs-whatever="@mdo">삭제하기</a>   
                </div>
            </div>`;
            $('#guestBook').append(temp_html);
        });

        // 수정/삭제 버튼 클릭
        $('.cardBtn').on('click', async function () {
            let type;
            if ($(this).hasClass("cardUpdateBtn")) type = 'update';
            else if ($(this).hasClass("cardDeleteBtn")) type = 'delete';

            let docId = $(this).parent().siblings('.cardId').val();

            // 비밀번호 확인
            $('#checkPasswordBtn').on('click', async function () {
                let chkPw = $('#chkPw').val();

                const docRef = doc(db, "postings", docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.data().password == chkPw) {
                    // 수정인 경우
                    if (type == 'update') {
                        $('#editUsername').val(docSnap.data().username);
                        $('#editMessage').val(docSnap.data().message);
                        cardUpdate(docId);
                    }
                    // 삭제인 경우 
                    else if (type == 'delete') {
                        cardDelete(docId);
                    }
                }
                else {
                    alert("비밀번호가 틀립니다.");
                    return;
                }
            });
        });

        // 빙명록 수정
        function cardUpdate(docId) {
            $('#editModal').modal('show');
            $('#saveMessageBtn').on('click', async function () {
                let editMessage = $('#editMessage').val();
                const docRef = doc(db, "postings", docId);
                await updateDoc(docRef, {
                    message: editMessage, 
                });
                alert('수정 완료');
                window.location.reload();
            });
        }

        // 방명록 삭제
        async function cardDelete(docId) {
            const docRef = doc(db, "postings", docId);
            await deleteDoc(docRef);
            alert('삭제 완료');
            window.location.reload();
        }
    </script>
</head>

<body>
    <div class="wrap">
        <div>
            <h1 class="">당신의 흔적을 남길 장소입니다</h1>
            <p class="">하고싶은 말을 자유롭게 남겨주세요!</p>
            <button id="btn_toggle">접기</button>
        </div>

        <div class="myGuestBook" id="postingbox">
            <div>
                <label for="username">이름:</label>
                <input type="text" id="username" name="username" placeholder="이름을 입력하세요">
            </div>
            <div>
                <label for="password">비밀번호:</label>
                <input type="password" id="password" name="password">
            </div>
            <div>
                <label for="message">메시지:</label>
                <textarea id="message" name="message" rows="5" cols="50" placeholder="여기에 메시지를 작성하세요"></textarea>
            </div>
            <button id="btn_posting">남기기</button>
        </div>

        <!-- 방명록 카드 나열 -->
        <div class="myGuestBook">
            <div id="guestBook" class="row justify-content-center gap-3">

            </div>
        </div>
    </div>
    <!-- 비밀번호 입력 modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">비밀번호를 입력하세요.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="chkPw" class="col-form-label">비밀번호 : </label>
                            <input type="password" class="form-control" id="chkPw">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button id="checkPasswordBtn" type="button" class="btn btn-primary">확인</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 수정 modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">방명록을 수정하세요.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="editUsername" class="col-form-label">이름:</label>
                            <input type="text" class="form-control" id="editUsername" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editMessage" class="col-form-label">메시지:</label>
                            <textarea id="editMessage" class="form-control" rows="5" cols="50"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button id="saveMessageBtn" type="button" class="btn btn-primary">저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>