<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Members Introduction</title>
        <!-- jquery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <!-- bootstrap -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Gowun+Dodum&family=Roboto+Slab:wght@100..900&display=swap');

            * {
                font-family: 'NanumSquare', sans-serif;
            }

            .wrap {
                width: 1200px;
                margin: 0 auto;
                text-align: center;
            }

            .membertitle {
                height: 150px;
                color: white;
                background-color: blue;

                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
            }

            .mb-content {
                margin-top: 30px;
            }

            .btns {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;

                margin-bottom: 30px;
            }

            .space {
                width: 10px;
                height: auto;
                display: inline-block;
            }

            .img-fluid {
                width: 450px;
                height: 300px;
                border: 2px solid;
                border-radius: 7px;

                margin-top: 30px;
            }

            .container {
                display: flex;
                justify-content: center;
                flex-direction: column;
            }

            .btnedit {
                width: 150px;
                height: 50px;
                background-color: transparent;
                color: black;
                border: 1px solid;
                border-radius: 5px;
                align-items: center;

                margin-top: 20px;
            }

            .btndelete {
                width: 150px;
                height: 50px;
                background-color: transparent;
                color: black;
                border: 1px solid;
                border-radius: 5px;
                align-items: center;

                margin-top: 20px;
            }

            body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                flex-direction: column;
            }
        </style>
    </head>

    <body>
        <div class="wrap">
            <section class="team_section my-5">
                <div class="pricing-header p-3 pb-md-4 mx-auto text-center">
                    <h1 class="display-4 fw-normal text-body-emphasis">멤버 소개</h1>
                    <p class="fs-5 text-body-secondary">우리 팀의 예쁘고 귀엽고 깜찍하고 잘생기고 멋있는 멤버를 소개합니다.</p>
                </div>
            </section>
            <div>
                <div class="container">
                    <div>
                        <img
                            src="https://mblogthumb-phinf.pstatic.net/MjAyMDAyMTBfODAg/MDAxNTgxMzA0MTE3ODMy.ACRLtB9v5NH-I2qjWrwiXLb7TeUiG442cJmcdzVum7cg.eTLpNg_n0rAS5sWOsofRrvBy0qZk_QcWSfUiIagTfd8g.JPEG.lattepain/1581304118739.jpg?type=w800"
                            class="img-fluid"
                            alt="프로필"
                        />
                    </div>

                    <div class="mb-content">
                        <p>이름 :</p>
                        <p>한줄 소개 :</p>
                        <p>MBTI :</p>
                        <p>자신의 장점 :</p>
                    </div>
                </div>
                <div class="btns">
                    <button class="btnedit" id="editBtn">수정</button>
                    <div class="space"></div>
                    <button class="btndelete" id="deleteBtn">삭제</button>
                </div>
            </div>
        </div>

        <!-- modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">New message</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">이름:</label>
                                <input type="text" id="name" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">프로필 이미지:</label>
                                <input type="text" id="profileImg" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">한줄 소개:</label>
                                <input type="text" id="intro" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">MBTI:</label>
                                <input type="text" id="mbti" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">자신의 장점:</label>
                                <textarea class="form-control" id="merit" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="closeBtn" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">저장하기</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- bootstrap -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
        ></script>
        <script type="module">
            // Firebase SDK 라이브러리 가져오기
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
            import { getFirestore, doc, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

            // Firebase 구성 정보 설정
            const firebaseConfig = {
                apiKey: 'AIzaSyBkQICiWSjg5HOoTbRABf_3vKGWiRuXjXk',
                authDomain: 'sparta-99127.firebaseapp.com',
                projectId: 'sparta-99127',
                storageBucket: 'sparta-99127.firebasestorage.app',
                messagingSenderId: '21636541090',
                appId: '1:21636541090:web:53ae33565c0f1bed2745fb',
                measurementId: 'G-J0J83TFTXV',
            };

            // Firebase 인스턴스 초기화
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // URL 파라미터 가져오기 함수
            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    id: params.get('id'),
                    name: params.get('name'),
                    intro: params.get('intro'),
                    mbti: params.get('mbti'),
                    merit: params.get('merit'),
                    profileImg: params.get('profileImg'),
                };
            }

            // 페이지 로드 후 데이터 출력
            window.onload = function () {
                const { id, name, intro, mbti, merit, profileImg } = getQueryParams();

                // HTML 요소에 데이터 삽입
                document.querySelector('.pricing-header p').textContent = `우리 팀의 예쁘고 귀엽고 깜찍하고 잘생기고 멋있는 ${name}을(를) 소개합니다!`;
                document.querySelector('.img-fluid').src = profileImg;
                document.querySelector('.img-fluid').alt = `${name} 프로필 이미지`;
                document.querySelector('.mb-content').innerHTML = `
                    <p>이름 : ${name}</p>
                    <p>한줄 소개 : ${intro}</p>
                    <p>MBTI : ${mbti}</p>
                    <p>자신의 장점 : ${merit}</p>
                `;

                // 삭제 버튼에 문서 ID 추가
                document.getElementById('deleteBtn').setAttribute('data-id', id);
            };

            // 수정 버튼 클릭 이벤트
            document.getElementById('editBtn').addEventListener('click', function () {
                const { id, name, intro, mbti, merit, profileImg } = getQueryParams();

                // 모달에 기존 데이터 삽입
                document.getElementById('name').value = name;
                document.getElementById('profileImg').value = profileImg;
                document.getElementById('intro').value = intro;
                document.getElementById('mbti').value = mbti;
                document.getElementById('merit').value = merit;

                // 모달 띄우기
                const myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
                myModal.show();

                // 저장 버튼 클릭 이벤트
                document.getElementById('saveBtn').addEventListener('click', async function () {
                    const updatedName = document.getElementById('name').value;
                    const updatedProfileImg = document.getElementById('profileImg').value;
                    const updatedIntro = document.getElementById('intro').value;
                    const updatedMbti = document.getElementById('mbti').value;
                    const updatedMerit = document.getElementById('merit').value;

                    try {
                        // Firestore에서 해당 문서 업데이트
                        await updateDoc(doc(db, 'members', id), {
                            name: updatedName,
                            intro: updatedIntro,
                            mbti: updatedMbti,
                            merit: updatedMerit,
                            profileImg: updatedProfileImg,
                        });

                        alert('수정되었습니다.');
                        
                        // 페이지 내의 데이터를 동적으로 업데이트
                        document.querySelector(
                            '.pricing-header p'
                        ).textContent = `우리 팀의 예쁘고 귀엽고 깜찍하고 잘생기고 멋있는 ${updatedName}을(를) 소개합니다!`;
                        document.querySelector('.img-fluid').src = updatedProfileImg;
                        document.querySelector('.img-fluid').alt = `${updatedName} 프로필 이미지`;
                        document.querySelector('.mb-content').innerHTML = `
                            <p>이름 : ${updatedName}</p>
                            <p>한줄 소개 : ${updatedIntro}</p>
                            <p>MBTI : ${updatedMbti}</p>
                            <p>자신의 장점 : ${updatedMerit}</p>
                        `;

                        // 모달 닫기
                        myModal.hide();

                        // 페이지 새로 고침
                        location.reload(); // 페이지 새로 고침
                    } catch (error) {
                        console.error('수정 중 오류 발생:', error);
                        alert('수정에 실패했습니다.');
                    }
                });
            });

            // 삭제 버튼 클릭 이벤트
            document.getElementById('deleteBtn').addEventListener('click', async function () {
                const memberId = this.getAttribute('data-id'); // Firebase 문서 ID 가져오기

                if (confirm('정말로 삭제하시겠습니까?')) {
                    try {
                        // Firebase에서 해당 멤버 삭제
                        await deleteDoc(doc(db, 'members', memberId));

                        alert('삭제되었습니다.');
                        window.location.href = 'main.html'; // 메인 페이지로 리다이렉트
                    } catch (error) {
                        console.error('삭제 중 오류 발생:', error);
                        alert('삭제에 실패했습니다.');
                    }
                }
            });
        </script>
    </body>
</html>
