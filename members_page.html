<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Members Introduction</title>
        <!-- jquery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <!-- bootstrap -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Gowun+Dodum&family=Roboto+Slab:wght@100..900&display=swap');

            * {
                font-family: 'NanumSquare', sans-serif;
            }

            .wrap {
                width: 1200px;
                margin: 0 auto;
            }

            .mb-content {
                margin-top: 50px;
                margin-bottom: 30px;
            }

            .space {
                width: 10px;
                height: auto;
                display: inline-block;
            }

            .img-fluid {
                width: 450px;
                height: 300px;
                border: 2px solid;
                border-radius: 7px;
                object-fit: cover;
            }

            .container {
                display: flex;
                justify-content: center;
                flex-direction: column;
            }

            .btns {
                margin-bottom: 30px;
            }

            body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                flex-direction: column;
            }
        </style>
    </head>

    <body>
        <!-- navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-primary py-3 position-fixed w-100 top-0 left-0 z-3">
            <div class="wrap d-flex">
                <a class="navbar-brand text-light" href="index.html">IS</a>
                <button
                    class="navbar-toggler"
                    type="button"
                    data-toggle="collapse"
                    data-target="#navbarNav"
                    aria-controls="navbarNav"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item active">
                            <a class="nav-link text-light" href="index.html">팀 소개</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-light" href="#member_section">멤버 소개</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-light" href="guestbook.html">방명록</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="wrap">
            <div class="text-center">
                <section class="team_section my-5">
                    <div class="pricing-header p-3 pb-md-4 mx-auto text-center">
                        <h1 class="display-4 fw-normal text-body-emphasis">멤버 소개</h1>
                        <p class="fs-5 text-body-secondary">우리 팀의 예쁘고 귀엽고 깜찍하고 잘생기고 멋있는 멤버를 소개합니다.</p>
                    </div>
                </section>
                <div>
                    <div class="container">
                        <div>
                            <img
                                src="https://mblogthumb-phinf.pstatic.net/MjAyMDAyMTBfODAg/MDAxNTgxMzA0MTE3ODMy.ACRLtB9v5NH-I2qjWrwiXLb7TeUiG442cJmcdzVum7cg.eTLpNg_n0rAS5sWOsofRrvBy0qZk_QcWSfUiIagTfd8g.JPEG.lattepain/1581304118739.jpg?type=w800"
                                class="img-fluid"
                                alt="프로필"
                            />
                        </div>

                        <div class="mb-content">
                            <p>이름 :</p>
                            <p>한줄 소개 :</p>
                            <p>MBTI :</p>
                            <p>자신의 장점 :</p>
                        </div>
                    </div>
                    <div class="btns">
                        <button type="button" id="editBtn" class="btn btn-lg btn-outline-primary">수정하기</button>
                        <div class="space"></div>
                        <button type="button" id="deleteBtn" class="btn btn-lg btn-outline-primary">삭제하기</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">수정하기</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">이름:</label>
                                <input type="text" id="name" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">프로필 이미지:</label>
                                <input type="text" id="profileImg" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">한줄 소개:</label>
                                <input type="text" id="intro" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">MBTI:</label>
                                <input type="text" id="mbti" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="message-text" class="col-form-label">자신의 장점:</label>
                                <textarea class="form-control" id="merit" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="col-form-label">비밀번호:</label>
                                <input type="password" id="password" class="form-control" required />
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="closeBtn" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">저장하기</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 비밀번호 입력 modal -->
        <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="passwordModalLabel">비밀번호 확인</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="deletePassword" class="form-label">비밀번호</label>
                            <input type="password" id="deletePassword" class="form-control" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">삭제하기</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- bootstrap -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
        ></script>
        <script type="module">
            // Firebase SDK 라이브러리 가져오기
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
            import { getFirestore, doc, deleteDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

            // Firebase 구성 정보 설정
            const firebaseConfig = {
                apiKey: 'AIzaSyBkQICiWSjg5HOoTbRABf_3vKGWiRuXjXk',
                authDomain: 'sparta-99127.firebaseapp.com',
                projectId: 'sparta-99127',
                storageBucket: 'sparta-99127.firebasestorage.app',
                messagingSenderId: '21636541090',
                appId: '1:21636541090:web:53ae33565c0f1bed2745fb',
                measurementId: 'G-J0J83TFTXV',
            };

            // Firebase 인스턴스 초기화
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // URL 파라미터 가져오기 함수
            function getQueryParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    id: params.get('id'),
                    name: params.get('name'),
                    intro: params.get('intro'),
                    mbti: params.get('mbti'),
                    merit: params.get('merit'),
                    profileImg: params.get('profileImg'),
                };
            }

            // 페이지 로드 후 데이터 출력
            window.onload = function () {
                const { id, name, intro, mbti, merit, profileImg } = getQueryParams();

                // HTML 요소에 데이터 삽입
                document.querySelector('.pricing-header p').textContent = `우리 팀의 예쁘고 귀엽고 깜찍하고 잘생기고 멋있는 ${name}을(를) 소개합니다!`;
                document.querySelector('.img-fluid').src = profileImg;
                document.querySelector('.img-fluid').alt = `${name} 프로필 이미지`;
                document.querySelector('.mb-content').innerHTML = `
                    <p>이름 : ${name}</p>
                    <p>한줄 소개 : ${intro}</p>
                    <p>MBTI : ${mbti}</p>
                    <p>자신의 장점 : ${merit}</p>
                `;

                // 삭제 버튼에 문서 ID 추가
                document.getElementById('deleteBtn').setAttribute('data-id', id);
            };

            // 수정 버튼 클릭 이벤트
            document.getElementById('editBtn').addEventListener('click', async function () {
                const { id } = getQueryParams(); // URL에서 id만 가져옴

                try {
                    // Firebase에서 최신 데이터 가져오기
                    const docRef = doc(db, 'members', id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data(); // 최신 데이터

                        // 모달에 최신 데이터 삽입
                        document.getElementById('name').value = data.name;
                        document.getElementById('profileImg').value = data.profileImg;
                        document.getElementById('intro').value = data.intro;
                        document.getElementById('mbti').value = data.mbti;
                        document.getElementById('merit').value = data.merit;

                        // 비밀번호 필드 초기화
                        document.getElementById('password').value = '';

                        // 모달 띄우기
                        const myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
                        myModal.show();

                        // 기존 이벤트 리스너 제거 후 등록
                        document.getElementById('saveBtn').replaceWith(document.getElementById('saveBtn').cloneNode(true));
                        document.getElementById('saveBtn').addEventListener('click', async function () {
                            const inputPassword = document.getElementById('password').value;

                            // 비밀번호 확인
                            if (data.password !== inputPassword) {
                                alert('비밀번호가 일치하지 않습니다.');
                                return;
                            }

                            const updatedName = document.getElementById('name').value;
                            const updatedProfileImg = document.getElementById('profileImg').value;
                            const updatedIntro = document.getElementById('intro').value;
                            const updatedMbti = document.getElementById('mbti').value;
                            const updatedMerit = document.getElementById('merit').value;

                            try {
                                await updateDoc(doc(db, 'members', id), {
                                    name: updatedName,
                                    intro: updatedIntro,
                                    mbti: updatedMbti,
                                    merit: updatedMerit,
                                    profileImg: updatedProfileImg,
                                });

                                alert('수정되었습니다.');

                                // DOM 업데이트
                                document.querySelector(
                                    '.pricing-header p'
                                ).textContent = `우리 팀의 예쁘고 귀엽고 깜찍하고 잘생기고 멋있는 ${updatedName}을(를) 소개합니다!`;
                                document.querySelector('.img-fluid').src = updatedProfileImg;
                                document.querySelector('.img-fluid').alt = `${updatedName} 프로필 이미지`;
                                document.querySelector('.mb-content').innerHTML = `
                        <p>이름 : ${updatedName}</p>
                        <p>한줄 소개 : ${updatedIntro}</p>
                        <p>MBTI : ${updatedMbti}</p>
                        <p>자신의 장점 : ${updatedMerit}</p>
                    `;

                                // 모달 닫기
                                myModal.hide();
                            } catch (error) {
                                console.error('수정 중 오류 발생:', error);
                                alert('수정에 실패했습니다.');
                            }
                        });
                    } else {
                        alert('데이터를 찾을 수 없습니다.');
                    }
                } catch (error) {
                    console.error('데이터 가져오기 오류:', error);
                    alert('데이터를 가져오는 데 실패했습니다.');
                }
            });

            // 삭제 버튼 클릭 이벤트
            document.getElementById('deleteBtn').addEventListener('click', function () {
                const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
                passwordModal.show();

                // 기존 이벤트 리스너 제거 후 등록
                document.getElementById('confirmDeleteBtn').replaceWith(document.getElementById('confirmDeleteBtn').cloneNode(true));
                document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
                    const password = document.getElementById('deletePassword').value;
                    const memberId = document.getElementById('deleteBtn').getAttribute('data-id'); // 문서 ID 가져오기
                  
                    try {
                        // Firebase에서 비밀번호 가져오기
                        const docRef = doc(db, 'members', memberId); // 'members'는 Firestore 컬렉션 이름
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const correctPassword = data.password; // Firestore에 저장된 비밀번호

                            // 비밀번호 검증
                            if (!password || password !== correctPassword) {
                                alert('비밀번호가 올바르지 않습니다.');
                                return;
                            }

                            // 비밀번호가 일치하면 삭제 수행
                            if (confirm('정말로 삭제하시겠습니까?')) {
                                await deleteDoc(doc(db, 'members', memberId));
                                alert('삭제되었습니다.');
                                window.location.href = 'index.html'; // 메인 페이지로 리다이렉트
                            }
                        } else {
                            alert('해당 멤버 정보를 찾을 수 없습니다.');
                        }
                    } catch (error) {
                        console.error('비밀번호 확인 중 오류 발생:', error);
                        alert('비밀번호 확인 중 문제가 발생했습니다.');
                    }
                });
            });
        </script>
    </body>
</html>
